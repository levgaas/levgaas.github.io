(function($,window,document,undefined){"use strict";var pluginName="jPhotoGrid";var defaults={itemsType:"img",margin:0,isFirstRowBig:false,isCentred:true,isSmallImageStretched:false,minRelation:.4,onComplete:function(){},onProgress:function(instance,image){}};function Plugin(element,options){this.element=element;this._defaults=defaults;this._name=pluginName;this.options=$.extend({},defaults,options);this.action=typeof options==="string"?options:"default";this.init()}Plugin.prototype.init=function(){switch(this.action){case"clear":return this.clear();break;default:return this.waitForImageLoaded()}};Plugin.prototype.waitForImageLoaded=function(){var it=this;var hasDimensions=true;$(it.element).find(it.options.itemsType).each(function(){hasDimensions=hasDimensions&(!!$(this).attr("height")&!!$(this).attr("width"))});var waitForImagesLoaded=!hasDimensions;if(waitForImagesLoaded){$(it.element).imagesLoaded().done(function(){it.start()}).progress(function(instance,image){it.options.onProgress&&it.options.onProgress(instance,image)})}else{it.start()}};Plugin.prototype.start=function(){var it=this;var numRow=0;var classWidth=0;this.clear();var $images=$(it.element).find(it.options.itemsType);var isImageLessThanElement=function(){return $images[0].naturalWidth<it.getWidth($(it.element))&&$images[0].naturalHeight<it.getHeight($(it.element))};if(!it.options.isSmallImageStretched&&$images.length===1&&isImageLessThanElement()){$images.width($images[0].naturalWidth);$images.height($images[0].naturalHeight);it.displayItems();$(it.element).append("<div class='jPhotoGrid-clear'></div>");return}it.options.minRowHeight=function computeMinRowHeight($images){var reqWidth=Math.sqrt(it.getHeight($(it.element))*it.getWidth($(it.element))/$images.length);var minRowHeight=Infinity;$images.each(function(){var temp=this.naturalHeight/this.naturalWidth*reqWidth;if(temp<minRowHeight){minRowHeight=temp}});minRowHeight+=2*$images.length/3;return minRowHeight}($images);if(it.options.isFirstRowBig){it.reverseItems()}$(it.element).addClass("jPhotoGrid-selector");var $elements=$(it.element).find(it.options.itemsType);var rowHeightArray=[];var copyElements=[];$elements.each(function(i){$(this).addClass("jPhotoGrid-item");var newWidth=it.itemNewWidth(this,it.options.minRowHeight);$(this).css({margin:it.options.margin+"px"});var elementOuterWidth=newWidth+2*it.options.margin;if(i==0||classWidth+elementOuterWidth<=it.getWidth($(it.element))){classWidth+=elementOuterWidth}else{rowHeightArray.push(it.stretchingRow(".jPhotoGrid-row_"+numRow,classWidth,copyElements));classWidth=elementOuterWidth;numRow++}copyElements.push({className:".jPhotoGrid-row_"+numRow,width:newWidth,height:it.options.minRowHeight});$(this).addClass("jPhotoGrid-row_"+numRow);if(i==$elements.length-1){rowHeightArray.push(it.stretchingRow(".jPhotoGrid-row_"+numRow,classWidth,copyElements))}});if(it.options.isFirstRowBig){it.reverseItems();rowHeightArray.reverse();copyElements.reverse()}var rowsHeightSum=0;for(var i=0;i<rowHeightArray.length;i++){rowsHeightSum+=rowHeightArray[i]}if(rowsHeightSum>it.getHeight($(it.element))){this.wrapImages(rowsHeightSum,rowHeightArray,$,it)}it.displayItems();$(it.element).append("<div class='jPhotoGrid-clear'></div>")};Plugin.prototype.itemNewWidth=function(item,newHeight){var width=typeof $(item).attr("width")!="undefined"?$(item).attr("width"):this.getWidth($(item));var height=typeof $(item).attr("height")!="undefined"?$(item).attr("height"):this.getHeight($(item));var prop=width/height;var newWidth=newHeight*prop;return Math.round(newWidth)};Plugin.prototype.stretchingRow=function(className,classWidth,copyElements){var it=this;var row=$(it.element).find(className);var rowElementsArray=$.grep(copyElements,function(e){return e.className==className.toString()});var classHeight=Math.round(rowElementsArray[0].height)+2*it.options.margin;var requiredWidth=it.getWidth($(it.element));var requiredHeight=classHeight/classWidth*requiredWidth;var resultWidth=0;row.each(function(i){$(this).width(it.itemNewWidth(rowElementsArray[i],requiredHeight-it.options.margin*2));resultWidth+=it.getWidth($(this))+2*it.options.margin});row.height(requiredHeight-it.options.margin*2);var lastElementWidth=it.getWidth(row.last())+2*it.options.margin+(requiredWidth-resultWidth)-it.options.margin*2;row.last().width(lastElementWidth);return requiredHeight};Plugin.prototype.wrapImages=function(rowsHeightSum,rowHeightArray,$,it){(function computeRowHeight(){var biggestRelationElement=-Infinity;var indexOfBiggestRelElem;for(var j=0;j<rowHeightArray.length;j++){rowHeightArray[j]/=rowsHeightSum;if(rowHeightArray[j]>=biggestRelationElement){indexOfBiggestRelElem=j;biggestRelationElement=rowHeightArray[j]}}var relationsArray=[];for(var k=0;k<rowHeightArray.length;k++){var $rowElements=$(it.element).find(".jPhotoGrid-row_"+(it.options.isFirstRowBig?rowHeightArray.length-k-1:k));var smallestRelationInRow={width:0,rel:Infinity};$rowElements.each(function(){var width=it.getWidth($(this));var height=rowHeightArray[k]*it.getHeight($(it.element))-2*it.options.margin;var rel=height/width;if(rel<smallestRelationInRow.rel){smallestRelationInRow.rel=rel;smallestRelationInRow.width=width}});relationsArray.push(smallestRelationInRow)}var biggestRowCanGive=relationsArray[indexOfBiggestRelElem].width*(relationsArray[indexOfBiggestRelElem].rel-it.options.minRelation);if(biggestRowCanGive>0){for(var i=0;i<relationsArray.length;i++){if(i===indexOfBiggestRelElem){continue}if(relationsArray[i].rel<it.options.minRelation){var thisNeeded=(it.options.minRelation-relationsArray[i].rel)*relationsArray[i].width;var taken;if(biggestRowCanGive<thisNeeded){taken=biggestRowCanGive}else{taken=thisNeeded;biggestRowCanGive=biggestRowCanGive-taken}var takenRel=taken/it.getHeight($(it.element));rowHeightArray[i]+=takenRel;rowHeightArray[indexOfBiggestRelElem]-=takenRel}}}})();var wrapElementWithDiv=function(counter,margin_top){$(this).wrap("<div class='jPhotoGrid_image_wrapper' style='overflow: hidden; height: "+(rowHeightArray[counter]*it.getHeight($(it.element))-2*it.options.margin)+"px; width: "+(it.getWidth($(this))+2*it.options.margin)+"px; float:left; margin-top: "+margin_top+"px;'></div>")};for(var k=0;k<rowHeightArray.length;k++){var $rowElements=$(it.element).find(".jPhotoGrid-row_"+(it.options.isFirstRowBig?rowHeightArray.length-k-1:k));$rowElements.each(function(){if(k===0){wrapElementWithDiv.call(this,k,it.options.margin)}else{wrapElementWithDiv.call(this,k,2*it.options.margin)}$(this).css({"margin-top":-(it.getHeight($(this))-rowHeightArray[k]*it.getHeight($(it.element)))/2-it.options.margin+"px"})})}};Plugin.prototype.getWidth=function($elem){var item=$elem[0];if(item==undefined){return undefined}var res;if(item.getBoundingClientRect().width!==0){res=item.getBoundingClientRect().width}else{var width=item.style.width.replace("px","");if(width!==""&&parseFloat(width)!==0){res=parseFloat(width)}else{res=Math.max(item.scrollWidth,item.offsetWidth,item.clientWidth,item.naturalWidth)}}return Math.round((res+1e-5)*100)/100};Plugin.prototype.getHeight=function($elem){var item=$elem[0];if(item==undefined){return undefined}var res;if(item.getBoundingClientRect().height!==0){res=item.getBoundingClientRect().height}else{var height=item.style.height.replace("px","");if(height!==""&&parseFloat(height)!==0){res=parseFloat(height)}else{res=Math.max(item.scrollHeight,item.offsetHeight,item.clientHeight,item.naturalHeight)}}return Math.round((res+1e-5)*100)/100};Plugin.prototype.reverseItems=function(){var it=this;var items=$.makeArray($(it.element).find(it.options.itemsType));items.reverse();$(it.element).html(items)};Plugin.prototype.displayItems=function(){var it=this;var $images=$(it.element).find(this.options.itemsType);$images.each(function(){$(this).removeAttr("display").css({display:"inline","float":"left"})});if(it.options.isCentred){var $wrappers=$(it.element).find(".jPhotoGrid_image_wrapper");if($wrappers.length!=0){$wrappers.wrapAll("<div class='jPhotoGrid_centred_block' style='display: inline-block;'></div>")}else{$images.wrapAll("<div class='jPhotoGrid_centred_block' style='display: inline-block;'></div>")}var $elem=$(it.element).find(".jPhotoGrid_centred_block");$elem.last().append("<div style='clear: both;'></div>");$elem.removeAttr("margin").css({"padding-top":(it.getHeight($(it.element))-it.getHeight($elem))/2-it.options.margin+"px","padding-left":(it.getWidth($(it.element))-it.getWidth($elem))/2+"px"})}it.options.onComplete()};Plugin.prototype.clear=function(){var it=this;$(it.element).find(".jPhotoGrid-item").each(function(){$(this)[0].className=$(this)[0].className.replace(/\bjPhotoGrid-row_.*?\b/g,"")});$(it.element).find(".jPhotoGrid-item").removeClass("jPhotoGrid-item");$(it.element).find(".jPhotoGrid-clear").remove();$(it.element).removeClass("jPhotoGrid-selector");it.deepClear()};Plugin.prototype.deepClear=function(){var it=this;var items=$(it.element).find(it.options.itemsType);$(it.element).html(items)};$.fn[pluginName]=function(options){return this.each(function(){$.data(this,"plugin_"+pluginName,new Plugin(this,options))})}})(jQuery,window,document);(function(){"use strict";function EventEmitter(){}var proto=EventEmitter.prototype;var exports=this;var originalGlobalValue=exports.EventEmitter;function indexOfListener(listeners,listener){var i=listeners.length;while(i--){if(listeners[i].listener===listener){return i}}return-1}function alias(name){return function aliasClosure(){return this[name].apply(this,arguments)}}proto.getListeners=function getListeners(evt){var events=this._getEvents();var response;var key;if(evt instanceof RegExp){response={};for(key in events){if(events.hasOwnProperty(key)&&evt.test(key)){response[key]=events[key]}}}else{response=events[evt]||(events[evt]=[])}return response};proto.flattenListeners=function flattenListeners(listeners){var flatListeners=[];var i;for(i=0;i<listeners.length;i+=1){flatListeners.push(listeners[i].listener)}return flatListeners};proto.getListenersAsObject=function getListenersAsObject(evt){var listeners=this.getListeners(evt);var response;if(listeners instanceof Array){response={};response[evt]=listeners}return response||listeners};proto.addListener=function addListener(evt,listener){var listeners=this.getListenersAsObject(evt);var listenerIsWrapped=typeof listener==="object";var key;for(key in listeners){if(listeners.hasOwnProperty(key)&&indexOfListener(listeners[key],listener)===-1){listeners[key].push(listenerIsWrapped?listener:{listener:listener,once:false})}}return this};proto.on=alias("addListener");proto.addOnceListener=function addOnceListener(evt,listener){return this.addListener(evt,{listener:listener,once:true})};proto.once=alias("addOnceListener");proto.defineEvent=function defineEvent(evt){this.getListeners(evt);return this};proto.defineEvents=function defineEvents(evts){for(var i=0;i<evts.length;i+=1){this.defineEvent(evts[i])}return this};proto.removeListener=function removeListener(evt,listener){var listeners=this.getListenersAsObject(evt);var index;var key;for(key in listeners){if(listeners.hasOwnProperty(key)){index=indexOfListener(listeners[key],listener);if(index!==-1){listeners[key].splice(index,1)}}}return this};proto.off=alias("removeListener");proto.addListeners=function addListeners(evt,listeners){return this.manipulateListeners(false,evt,listeners)};proto.removeListeners=function removeListeners(evt,listeners){return this.manipulateListeners(true,evt,listeners)};proto.manipulateListeners=function manipulateListeners(remove,evt,listeners){var i;var value;var single=remove?this.removeListener:this.addListener;var multiple=remove?this.removeListeners:this.addListeners;if(typeof evt==="object"&&!(evt instanceof RegExp)){for(i in evt){if(evt.hasOwnProperty(i)&&(value=evt[i])){if(typeof value==="function"){single.call(this,i,value)}else{multiple.call(this,i,value)}}}}else{i=listeners.length;while(i--){single.call(this,evt,listeners[i])}}return this};proto.removeEvent=function removeEvent(evt){var type=typeof evt;var events=this._getEvents();var key;if(type==="string"){delete events[evt]}else if(evt instanceof RegExp){for(key in events){if(events.hasOwnProperty(key)&&evt.test(key)){delete events[key]}}}else{delete this._events}return this};proto.removeAllListeners=alias("removeEvent");proto.emitEvent=function emitEvent(evt,args){var listenersMap=this.getListenersAsObject(evt);var listeners;var listener;var i;var key;var response;for(key in listenersMap){if(listenersMap.hasOwnProperty(key)){listeners=listenersMap[key].slice(0);i=listeners.length;while(i--){listener=listeners[i];if(listener.once===true){this.removeListener(evt,listener.listener)}response=listener.listener.apply(this,args||[]);if(response===this._getOnceReturnValue()){this.removeListener(evt,listener.listener)}}}}return this};proto.trigger=alias("emitEvent");proto.emit=function emit(evt){var args=Array.prototype.slice.call(arguments,1);return this.emitEvent(evt,args)};proto.setOnceReturnValue=function setOnceReturnValue(value){this._onceReturnValue=value;return this};proto._getOnceReturnValue=function _getOnceReturnValue(){if(this.hasOwnProperty("_onceReturnValue")){return this._onceReturnValue}else{return true}};proto._getEvents=function _getEvents(){return this._events||(this._events={})};EventEmitter.noConflict=function noConflict(){exports.EventEmitter=originalGlobalValue;return EventEmitter};if(typeof define==="function"&&define.amd){define("eventEmitter/EventEmitter",[],function(){return EventEmitter})}else if(typeof module==="object"&&module.exports){module.exports=EventEmitter}else{exports.EventEmitter=EventEmitter}}).call(this);(function(window,factory){"use strict";if(typeof define=="function"&&define.amd){define(["eventEmitter/EventEmitter"],function(EventEmitter){return factory(window,EventEmitter)})}else if(typeof module=="object"&&module.exports){module.exports=factory(window,require("wolfy87-eventemitter"))}else{window.imagesLoaded=factory(window,window.EventEmitter)}})(window,function factory(window,EventEmitter){var $=window.jQuery;var console=window.console;function extend(a,b){for(var prop in b){a[prop]=b[prop]}return a}function makeArray(obj){var ary=[];if(Array.isArray(obj)){ary=obj}else if(typeof obj.length=="number"){for(var i=0;i<obj.length;i++){ary.push(obj[i])}}else{ary.push(obj)}return ary}function ImagesLoaded(elem,options,onAlways){if(!(this instanceof ImagesLoaded)){return new ImagesLoaded(elem,options,onAlways)}if(typeof elem=="string"){elem=document.querySelectorAll(elem)}this.elements=makeArray(elem);this.options=extend({},this.options);if(typeof options=="function"){onAlways=options}else{extend(this.options,options)}if(onAlways){this.on("always",onAlways)}this.getImages();if($){this.jqDeferred=new $.Deferred}setTimeout(function(){this.check()}.bind(this))}ImagesLoaded.prototype=Object.create(EventEmitter.prototype);ImagesLoaded.prototype.options={};ImagesLoaded.prototype.getImages=function(){this.images=[];this.elements.forEach(this.addElementImages,this)};ImagesLoaded.prototype.addElementImages=function(elem){if(elem.nodeName=="IMG"){this.addImage(elem)}if(this.options.background===true){this.addElementBackgroundImages(elem)}var nodeType=elem.nodeType;if(!nodeType||!elementNodeTypes[nodeType]){return}var childImgs=elem.querySelectorAll("img");for(var i=0;i<childImgs.length;i++){var img=childImgs[i];this.addImage(img)}if(typeof this.options.background=="string"){var children=elem.querySelectorAll(this.options.background);for(i=0;i<children.length;i++){var child=children[i];this.addElementBackgroundImages(child)}}};var elementNodeTypes={1:true,9:true,11:true};ImagesLoaded.prototype.addElementBackgroundImages=function(elem){var style=getComputedStyle(elem);if(!style){return}var reURL=/url\((['"])?(.*?)\1\)/gi;var matches=reURL.exec(style.backgroundImage);while(matches!==null){var url=matches&&matches[2];if(url){this.addBackground(url,elem)}matches=reURL.exec(style.backgroundImage)}};ImagesLoaded.prototype.addImage=function(img){var loadingImage=new LoadingImage(img);this.images.push(loadingImage)};ImagesLoaded.prototype.addBackground=function(url,elem){var background=new Background(url,elem);this.images.push(background)};ImagesLoaded.prototype.check=function(){var _this=this;this.progressedCount=0;this.hasAnyBroken=false;if(!this.images.length){this.complete();return}function onProgress(image,elem,message){setTimeout(function(){_this.progress(image,elem,message)})}this.images.forEach(function(loadingImage){loadingImage.once("progress",onProgress);loadingImage.check()})};ImagesLoaded.prototype.progress=function(image,elem,message){this.progressedCount++;this.hasAnyBroken=this.hasAnyBroken||!image.isLoaded;this.emit("progress",this,image,elem);if(this.jqDeferred&&this.jqDeferred.notify){this.jqDeferred.notify(this,image)}if(this.progressedCount==this.images.length){this.complete()}if(this.options.debug&&console){console.log("progress: "+message,image,elem)}};ImagesLoaded.prototype.complete=function(){var eventName=this.hasAnyBroken?"fail":"done";this.isComplete=true;this.emit(eventName,this);this.emit("always",this);if(this.jqDeferred){var jqMethod=this.hasAnyBroken?"reject":"resolve";this.jqDeferred[jqMethod](this)}};function LoadingImage(img){this.img=img}LoadingImage.prototype=Object.create(EventEmitter.prototype);LoadingImage.prototype.check=function(){var isComplete=this.getIsImageComplete();if(isComplete){this.confirm(this.img.naturalWidth!==0,"naturalWidth");return}this.proxyImage=new Image;this.proxyImage.addEventListener("load",this);this.proxyImage.addEventListener("error",this);this.img.addEventListener("load",this);this.img.addEventListener("error",this);this.proxyImage.src=this.img.src};LoadingImage.prototype.getIsImageComplete=function(){return this.img.complete&&this.img.naturalWidth!==undefined};LoadingImage.prototype.confirm=function(isLoaded,message){this.isLoaded=isLoaded;this.emit("progress",this,this.img,message)};LoadingImage.prototype.handleEvent=function(event){var method="on"+event.type;if(this[method]){this[method](event)}};LoadingImage.prototype.onload=function(){this.confirm(true,"onload");this.unbindEvents()};LoadingImage.prototype.onerror=function(){this.confirm(false,"onerror");this.unbindEvents()};LoadingImage.prototype.unbindEvents=function(){this.proxyImage.removeEventListener("load",this);this.proxyImage.removeEventListener("error",this);this.img.removeEventListener("load",this);this.img.removeEventListener("error",this)};function Background(url,element){this.url=url;this.element=element;this.img=new Image}Background.prototype=Object.create(LoadingImage.prototype);Background.prototype.check=function(){this.img.addEventListener("load",this);this.img.addEventListener("error",this);this.img.src=this.url;var isComplete=this.getIsImageComplete();if(isComplete){this.confirm(this.img.naturalWidth!==0,"naturalWidth");this.unbindEvents()}};Background.prototype.unbindEvents=function(){this.img.addEventListener("load",this);this.img.addEventListener("error",this)};Background.prototype.confirm=function(isLoaded,message){this.isLoaded=isLoaded;this.emit("progress",this,this.element,message)};ImagesLoaded.makeJQueryPlugin=function(jQuery){jQuery=jQuery||window.jQuery;if(!jQuery){return}$=jQuery;$.fn.imagesLoaded=function(options,callback){var instance=new ImagesLoaded(this,options,callback);return instance.jqDeferred.promise($(this))}};ImagesLoaded.makeJQueryPlugin();return ImagesLoaded});